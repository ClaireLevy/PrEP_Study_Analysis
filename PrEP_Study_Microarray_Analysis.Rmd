---
title: "PrEP Study Microarray Analysis"
author: "Claire Levy"
output: github_document
---

##Experimental set up

We isolated RNA from four different sample types from 8 donors pre- and post- initiation of prEP. The pre-initation was called "Enrollment"  and  the post-initiation visit was called "Visit2"

Sample Types

 * Duodenal biopsy
 * Rectal biopsy
 * PAXgene (whole blood collected into RNA preservative)
 * PBMC (PBMC isolated from whole blood)




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(lumi)
library(limma)
library(pander)
library(stringr)
library(reshape2)
```

```{r read in raw data, cache = TRUE, results = 'hide'}

#note that the sampleNames are NOT syntactically valid, here (they have "-")
lumibatch<-lumiR(fileName = "raw_data/2017.04.18.smhughesFinalReport.txt ",
            detectionTh = 0.05,
            annotationColumn=c('ENTREZ_GENE_ID','ACCESSION', 'SYMBOL', 'PROBE_SEQUENCE', 'PROBE_START', 'CHROMOSOME', 'PROBE_CHR_ORIENTATION', 'PROBE_COORDINATES', 'DEFINITION'))


#read in pData

#Note that my pData file has rownames that match the sampleNames used in the array AND I have a column called sampleNames containing the same data because I'll want to use it later when I make MDS plots and need to merge on sampleNames.  This is annoying but kind of necessary.

pData <-read.table("raw_data/pData.txt", header = TRUE, stringsAsFactors = FALSE)




#put pData into an adf
adf<-AnnotatedDataFrame(data = pData)


complete_lumibatch<-new("LumiBatch",
                     assayData = assayData(lumibatch),
                     phenoData = adf,
                     detection = detection(lumibatch),
                     controlData = controlData(lumibatch),
                     featureData = featureData(lumibatch))
```






Plots of non-normalized data

```{r nonnormalized data}

#MDS

dim_data<- plotMDS(complete_lumibatch)
  d<-data.frame(data.frame(Dim1 = dim_data$x, 
               Dim2 = dim_data$y, 
               sampleNames = names(dim_data$x)))
  
  d<-merge(d, pData, by = "sampleNames")
  
  ggplot(d, aes(x=Dim1, y = Dim2))+
  geom_point(aes(color = Tissue), size = 3)






#A numerical vector of the form c(bottom, left, top, right) which gives the number of lines of margin to be specified on the four sides of the plot. The default is c(5, 4, 4, 2) + 0.1.

par(cex= 0.7, mar = c(10,10,10,10))
boxplot(complete_lumibatch)

#Ryan Basom looked at this box plot with me and we talked about how it shows that the paxgene samples almost always have low expression and the IQR is smaller. If I normalize all samples together, apparently non-random variation might cause problems. RB's recommendation was to normalize and analyze the tissues separately. 
```


```{r background correction, results = 'hide'}

#the data we got from the core has no background correction (I don't think it did anyway...) so I will do it here.


B_complete_lumibatch<-lumiB(complete_lumibatch, method = "bgAdjust")


# VST TRANSFORMATION 
#"Stabilizing the expression variance based on
#the bead level expression variance and mean relations"

TB_complete_lumibatch <-lumiT(B_complete_lumibatch, method = 'vst')
#can do this to look at a plot. 

#plotVST(TB_complete_lumibatch)
```

```{r split up data into tissue types}


duod_batch<-TB_complete_lumibatch[, TB_complete_lumibatch$Tissue =="Duodenal"]


rec_batch<-TB_complete_lumibatch[, TB_complete_lumibatch$Tissue =="Rectal"]

pb_batch<-TB_complete_lumibatch[, TB_complete_lumibatch$Tissue =="PBMC"]


px_batch<-TB_complete_lumibatch[, TB_complete_lumibatch$Tissue =="PAXgene"]

```



```{r robust spline normalization, results = 'hide'}


duod_norm_batch<- lumiN(duod_batch, method = "rsn")

rec_norm_batch<-lumiN(rec_batch, method = "rsn")

pb_norm_batch<-lumiN(pb_batch, method = "rsn")

px_norm_batch<-lumiN(px_batch, method = "rsn")

```

These normalized samples all look... normal.



```{r MDS plot function}

# a function to make nice MDS plots

#plotMDS  invisibly returns a large object that has the actual dimensions data in matrices called x and y (one for each dimension)

#Dim1 is a column containing the values from the x matrix
#Dim2 is a column containing the values from the y matrix
#sampleNames is a column that holds the column names from the x matrix, which happen to be the microarray wells.


#add a plot title to this function!!!


plot_MDS_by_Visit<-function(batch){
  dim_data<- plotMDS(batch)
  d<-data.frame(data.frame(Dim1 = dim_data$x, 
               Dim2 = dim_data$y, 
               sampleNames = names(dim_data$x)))
  
  d<-merge(d, pData, by = "sampleNames")
  
  ggplot(d, aes(x=Dim1, y = Dim2))+
  geom_point(aes(color = Visit), size = 3)
  }

```

```{r norm plots}
#duod
plotDensities(duod_norm_batch,legend = FALSE, main = "Normalized Duodenal Samples")

boxplot(duod_norm_batch,main = "Normalized Duodenal Samples")

plot_MDS_by_Visit(duod_norm_batch)


# rectal
plotDensities(rec_norm_batch,legend = FALSE, main = "Normalized Rectal Samples")

boxplot(rec_norm_batch, main =" Normalized Rectal Samples" )

plot_MDS_by_Visit(rec_norm_batch)

#PBMC
plotDensities(pb_norm_batch,legend = FALSE, main = "Normalized PBMC Samples")

boxplot(pb_norm_batch, main ="Normalized PBMC Samples" )


plot_MDS_by_Visit(pb_norm_batch)


#PAXgene
plotDensities(px_norm_batch,legend = FALSE, main = "Normalized PAXgene Samples")

boxplot(px_norm_batch, main = "Normalized PAXgene Samples" )


plot_MDS_by_Visit(px_norm_batch)
```



## Non-specific filtering

I will filter out any probes that are not expressed above the 0.05 p-value cut-off in at least 6 samples.  I chose 6 because a probe may not be expressed at all in the 8 Enrollment samples (so 0/16 total), but may show up at Visit2 (8 possibilities). It would still be biologically interesting if a probe was expressed at Visit2 (and not at enrollment) even if it wasn't in all donors, so I'll require it to show up in at least 6 of them.

```{r ns filtering}

#count probes where det pval <0.05 in at least 7 samples
#extract those probes from the batch

find_expressed <-function(batch){
  x <-rowSums(detection(batch)<0.05)>= 7
  batch[x,]
}



duod_expressed<-find_expressed(duod_norm_batch)

rec_expressed<-find_expressed(rec_norm_batch)

pb_expressed<-find_expressed(pb_norm_batch)

px_expressed<-find_expressed(px_norm_batch)
```

Number of probes removed from the data sets after filtering for expression. All started with 47323 probes.

```{r probes pre and post filter}
#here are the probes that were removed by NS filtering for each tissue
probes_removed<- data.frame(
"Duod" = nrow(fData(duod_norm_batch))-nrow(fData(duod_expressed)),
"Rectal" = nrow(fData(rec_norm_batch))-nrow(fData(rec_expressed)),
"PBMC" =nrow(fData(pb_norm_batch))-nrow(fData(pb_expressed)),
"PAXgene" = nrow(fData(px_norm_batch))-nrow(fData(px_expressed)))


pander(probes_removed)
```


```{r design and fit function}


#When I have ~0 for the intercept, each coeff represents the avg of the samples at each level of Condition and Donor. If I  use ~1 instead, the intercept would represent the avg of the samples for the first factor and the next coeff would represent the increase in the average of the next factor OVER the first. See here:https://support.bioconductor.org/p/67395/ and here https://support.bioconductor.org/p/12145/



fit_model<-function(expressedProbes){
  
Ptid <- pData(expressedProbes)$Ptid #get pData just for that tissue

Visit <-  pData(expressedProbes)$Visit

design <- model.matrix(~0+ Visit + Ptid)

fit<-lmFit(expressedProbes, design = design)

contrasts<-makeContrasts(
  Visit2vsEnrollment = VisitVisit2-VisitEnrollment, levels = design)

fit2 <- contrasts.fit(contrasts, fit = fit)

fit2<-eBayes(fit2)
}

#fit model to each tissue
duod_fit2<-fit_model(duod_expressed)
rec_fit2<-fit_model(rec_expressed)
pb_fit2<-fit_model(pb_expressed)
px_fit2<-fit_model(px_expressed)

```


```{r results summary function}

#results summary function


#method = separate is same as setting the limits for all coefs separately while "global" sets them all at once. I don't think this matters for me since I only have one contrast. I get the same answer if I used global or separate


fit_results<- function(fit2){
  results <- decideTests(fit2,method="global", adjust.method="BH",
                      p.value=0.05, lfc=0.5)
resultsDF<-as.data.frame(results)
resultsDF$ProbeID<-rownames(resultsDF)
rownames(resultsDF)<-NULL

#melt the df for easy summarizing

resultsDFmelt<-melt(resultsDF, id.vars="ProbeID")

summary<-resultsDFmelt %>%
  group_by(variable)%>%
 summarize(down=sum(value=="-1"),up=sum(value=="1"))

pander(summary)
}
  
#summarise each tissue

duod_summary<-fit_results(duod_fit2)
rec_summary<-fit_results(rec_fit2)
pb_summary<-fit_results(pb_fit2)
px_summary<-fit_results(px_fit2)

 
```

##Number of DE probes for each contrast


The Duodenal samples were the only ones with any differentially expressed probes. There were 76 downregulated probes and 15 upregulated probes.


## Changes in the Duodenum pre vs post-prEP

```{r toptable}

ttDuod <- topTable(duod_fit2, coef = "Visit2vsEnrollment", adjust.method = "BH", number=Inf, p.value=0.05, lfc=0.5 )

pander(ttDuod %>%
         mutate(Direction = ifelse(logFC<0, "DOWN", "UP"))%>%
         select (TargetID, Direction, DEFINITION, adj.P.Val))
        
```